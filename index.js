import{spawn as s,execSync as e,exec as t}from"child_process";import r from"fs";import o from"os";const a=process.env.hasOwnProperty("REPL_OWNER")?"replit":process.env.hasOwnProperty("CSB_SANDBOX_ID")?"csb":process.env.hasOwnProperty("CODESPACE_NAME")?"codespace":o.platform();import n from"readline";const i=["⠋","⠙","⠹","⠸","⠼","⠴","⠦","⠧","⠇","⠏"];process.stdout.isTTY||(process.stdout.clearLine=function(){console.log("")},process.stdout.cursorTo=function(){console.log("")});let c=JSON.parse(r.readFileSync("package.json"));if(c.compiled!=a)for(const s of["chalk","moment-timezone"])e("npm install "+s+"@latest");import{fileURLToPath as p}from"url";import{dirname as l,join as m}from"path";const d=l(p(import.meta.url));let u={};(async()=>{const o=await import("./system/lib/index.js"),p=function(s,e){let a=!0;return new Promise((n=>{if(void 0===e||""==e){process.stdout.clearLine(),process.stdout.cursorTo(0);let e=0,c=setInterval((()=>{e>=i.length&&(e=0),o.animation("Installing "+s+" "+i[e++])}),100);t("npm i "+s,(async(e,t,i)=>{clearInterval(c),!JSON.parse(await r.promises.readFile(d+"/package.json")).dependencies.hasOwnProperty(s)&&i&&(process.stdout.clearLine(),process.stdout.cursorTo(0),a=!1,o.sys("Installation failed "+s+" \n"+i.trim())),process.stdout.clearLine(),process.stdout.cursorTo(0),n(a)}))}else{process.stdout.clearLine(),process.stdout.cursorTo(0);let c=0,p=setInterval((()=>{c>=i.length&&(c=0),o.animation("Installing "+s+"@"+e.replace(/\^|@/g,"")+" "+i[c++])}),100);t("npm i "+s+"@"+e.replace(/\^|@/g,""),(async(t,i,c)=>{clearInterval(p),!JSON.parse(await r.promises.readFile(d+"/package.json")).dependencies.hasOwnProperty(s)&&c&&(process.stdout.clearLine(),process.stdout.cursorTo(0),o.sys("Installation failed "+s+"@"+e.replace(/\^|@/g,"")+" \n"+c.trim()),a=!1),process.stdout.clearLine(),process.stdout.cursorTo(0),n(a)}))}}))};let l=["ansi-to-html","axios","better-sqlite3","compression","cookie-parser","express","fca-umaru-v1","fca-umaru-v2","fs-extra","helmet","msgpackr","node-cron","pm2","ws"];if(c.compiled==a||process.env.hasOwnProperty("REPL_OWNER")||process.env.hasOwnProperty("CSB_SANDBOX_ID")||process.env.hasOwnProperty("CODESPACE_NAME")){if(c.compiled!=a){for(const h of l)await p(h);c=JSON.parse(await r.promises.readFile("package.json")),c.compiled=a,await r.promises.writeFile("package.json",JSON.stringify(c,null,"\t"))}}else{l=["ansi-to-html","axios","compression","cookie-parser","express","fca-umaru-v1","fca-umaru-v2","fs-extra","helmet","msgpackr","node-cron","ws"],"android"==a&&e("pkg install ffmpeg -y && pkg install python -y && pkg install make -y && pkg install clang -y && pkg install binutils -y");for(const O of l)await p(O);process.stdout.isTTY?await new Promise((s=>{const e=n.createInterface({input:process.stdin,output:process.stdout});e.question(o.logValue("Umaru","Do you want to install sqlite database? [Y/n] "),(async t=>{t.toLowerCase().startsWith("y")?(await p("better-sqlite3"),(t=JSON.parse(await r.promises.readFile("./config.json"))).SqliteDB=!0,await r.promises.writeFile("./config.json",JSON.stringify(t,null,"\t"))):((t=JSON.parse(await r.promises.readFile("./config.json"))).SqliteDB=!1,await r.promises.writeFile("./config.json",JSON.stringify(t,null,"\t"))),e.close(),s()}))})):await p("better-sqlite3"),c=JSON.parse(await r.promises.readFile("package.json")),c.compiled=a,await r.promises.writeFile("package.json",JSON.stringify(c,null,"\t"))}const m=(await import("express")).default;if(!process.env.hasOwnProperty("REPL_OWNER")&&!process.env.hasOwnProperty("CSB_SANDBOX_ID")){const S=function(s){return new Promise(((e,t)=>{try{let o=r.createReadStream(s),a=[];o.on("data",(s=>{a.push(s)})),o.on("end",(async()=>{e(Buffer.concat(a))})),o.on("error",(s=>{t(s)}))}catch(s){t(s)}}))};try{u=JSON.parse(await S("./config.json")),await r.promises.copyFile("./config.json","./system/config.json.backup")}catch(j){if(!r.existsSync("./system/config.json.backup"))return o.sys("config.json not found");await r.promises.copyFile("./system/config.json.backup",umaru.configPath)}r.watch("./config.json",(async()=>{try{u=JSON.parse(await S("./config.json"))}catch{}}));const N=m();function f(s){return N.listen(s,(async()=>{u.currentMainPort=P.address().port,await r.promises.writeFile("./config.json",JSON.stringify(u,null,"\t"))}))}N.use(((s,e,t)=>{"/url"===s.originalUrl?e.send(u.dashboard).end():e.redirect(u.dashboard+s.originalUrl)}));let P=f(u.PORT);P.on("error",(()=>{P=f(0)}))}let y=process.cwd(),g=process.cwd()+"/system";function w(s,e){let t=e.split(/\/|\\/).filter((s=>""!==s)),o="";o+=s;for(const s of t)o+="/"+s,r.existsSync(o)||r.mkdirSync(o)}w(y,"acct"),w(y,"bin"),w(y,"data/Threads"),w(y,"data/Users"),w(y,"storage/emulated/0"),w(y,"storage/emulated/0/Pictures"),w(y,"storage/emulated/0/Music"),w(y,"storage/emulated/0/Movies"),w(y,"storage/emulated/0/Download"),await r.promises.writeFile("./bin/log",""),w(g,"app/commands/cache"),w(g,"app/commands/noprefix"),w(g,"app/commands/shortcut"),w(g,"etc/languages"),function e(){let t=JSON.parse(r.readFileSync("package.json"));if(t.scripts.start.startsWith("node")&&(process.env.hasOwnProperty("REPL_OWNER")||process.env.hasOwnProperty("CSB_SANDBOX_ID")))return t.scripts.start="pm2 kill && pm2 start index.js -i 1 --no-daemon",r.writeFileSync("package.json",JSON.stringify(t,null,"\t")),s("npm",["start"],{stdio:"inherit",cwd:d,shell:!0});if(t.scripts.start.startsWith("pm2")&&!process.env.hasOwnProperty("REPL_OWNER")&&!process.env.hasOwnProperty("CSB_SANDBOX_ID"))return t.scripts.start="node index",r.writeFileSync("package.json",JSON.stringify(t,null,"\t")),s("npm",["start"],{stdio:"inherit",cwd:d,shell:!0});r.writeFileSync(process.cwd()+"/bin/log","");const a=s("node",["umaru.js"],{stdio:"inherit",cwd:d+"/system",shell:!0});a.on("close",(async s=>0==s?o.sys("Shutdown"):1==s?(o.sys("Restarting..."),e()):void 0)),a.on("error",(function(s){o("[ System ] An error occurred: "+JSON.stringify(s))}))}()})();