const e=require("../utils"),t=require("npmlog");function n(e){return{reminderID:e.id,eventCreatorID:e.lightweight_event_creator.id,time:e.time,eventType:e.lightweight_event_type.toLowerCase(),locationName:e.location_name,locationCoordinates:e.location_coordinates,locationPage:e.location_page,eventStatus:e.lightweight_event_status.toLowerCase(),note:e.note,repeatMode:e.repeat_mode.toLowerCase(),eventTitle:e.event_title,triggerMessage:e.trigger_message,secondsToNotifyBefore:e.seconds_to_notify_before,allowsRsvp:e.allows_rsvp,relatedEvent:e.related_event,members:e.event_reminder_members.edges.map((function(e){return{memberID:e.node.id,state:e.guest_list_state.toLowerCase()}}))}}function a(e){if(e.errors)return e.errors;const t=e.message_thread;if(!t)return null;const a=t.last_message,i=a&&a.nodes&&a.nodes[0]&&a.nodes[0].message_sender&&a.nodes[0].message_sender.messaging_actor?a.nodes[0].message_sender.messaging_actor.id:null,s=a&&a.nodes&&a.nodes[0]?a.nodes[0].snippet:null,o=t.last_read_receipt,r=o&&o.nodes&&o.nodes[0]&&o.nodes[0].timestamp_precise?o.nodes[0].timestamp_precise:null;return{threadID:t.thread_key.thread_fbid?t.thread_key.thread_fbid:t.thread_key.other_user_id,threadName:t.name,participantIDs:t.all_participants.edges.map((e=>e.node.messaging_actor.id)),userInfo:t.all_participants.edges.map((e=>({id:e.node.messaging_actor.id,name:e.node.messaging_actor.name,firstName:e.node.messaging_actor.short_name,vanity:e.node.messaging_actor.username,url:e.node.messaging_actor.url,thumbSrc:e.node.messaging_actor.big_image_src.uri,profileUrl:e.node.messaging_actor.big_image_src.uri,gender:e.node.messaging_actor.gender,type:e.node.messaging_actor.__typename,isFriend:e.node.messaging_actor.is_viewer_friend,isBirthday:!!e.node.messaging_actor.is_birthday}))),unreadCount:t.unread_count,messageCount:t.messages_count,timestamp:t.updated_time_precise,muteUntil:t.mute_until,isGroup:"GROUP"==t.thread_type,isSubscribed:t.is_viewer_subscribed,isArchived:t.has_viewer_archived,folder:t.folder,cannotReplyReason:t.cannot_reply_reason,eventReminders:t.event_reminders?t.event_reminders.nodes.map(n):null,emoji:t.customization_info?t.customization_info.emoji:null,color:t.customization_info&&t.customization_info.outgoing_bubble_color?t.customization_info.outgoing_bubble_color.slice(2):null,threadTheme:t.thread_theme,nicknames:t.customization_info&&t.customization_info.participant_customizations?t.customization_info.participant_customizations.reduce((function(e,t){return t.nickname&&(e[t.participant_id]=t.nickname),e}),{}):{},adminIDs:t.thread_admins,approvalMode:Boolean(t.approval_mode),approvalQueue:t.group_approval_queue.nodes.map((e=>({inviterID:e.inviter.id,requesterID:e.requester.id,timestamp:e.request_timestamp,request_source:e.request_source}))),reactionsMuteMode:t.reactions_mute_mode.toLowerCase(),mentionsMuteMode:t.mentions_mute_mode.toLowerCase(),isPinProtected:t.is_pin_protected,relatedPageThread:t.related_page_thread,name:t.name,snippet:s,snippetSender:i,snippetAttachments:[],serverTimestamp:t.updated_time_precise,imageSrc:t.image?t.image.uri:null,isCanonicalUser:t.is_canonical_neo_user,isCanonical:"GROUP"!=t.thread_type,recipientsLoadable:!0,hasEmailParticipant:!1,readOnly:!1,canReply:null==t.cannot_reply_reason,lastMessageTimestamp:t.last_message?t.last_message.timestamp_precise:null,lastMessageType:"message",lastReadTimestamp:r,threadType:"GROUP"==t.thread_type?2:1,inviteLink:{enable:!!t.joinable_mode&&1==t.joinable_mode.mode,link:t.joinable_mode?t.joinable_mode.link:null}}}module.exports=function(n,i,s){return function(i,o){let r=function(){},_=function(){};const d=new Promise((function(e,t){r=e,_=t}));"Function"!=e.getType(o)&&"AsyncFunction"!=e.getType(o)&&(o=function(e,t){if(e)return _(e);r(t)}),"Array"!==e.getType(i)&&(i=[i]);let m={};return i.map((function(e,t){m["o"+t]={doc_id:"3449967031715030",query_params:{id:e,message_limit:0,load_messages:!1,load_read_receipts:!1,before:null}}})),m={queries:JSON.stringify(m),batch_name:"MessengerGraphQLThreadFetcher"},n.post("https://www.facebook.com/api/graphqlbatch/",s.jar,m).then(e.parseAndCheckLogin(s,n)).then((function(e){if(e.error)throw e;const t={};for(let n=e.length-2;n>=0;n--){const s=a(e[n][Object.keys(e[n])[0]].data);t[s?.threadID||i[i.length-1-n]]=s}1==Object.values(t).length?o(null,Object.values(t)[0]):o(null,t)})).catch((function(e){return t.error("getThreadInfoGraphQL",e),o(e)})),d}};