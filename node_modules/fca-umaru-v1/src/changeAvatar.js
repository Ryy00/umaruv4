const e=require("../utils"),r=require("npmlog"),t=require("bluebird");module.exports=function(i,n,o){return function(n,u="",a=null,c){let s=function(){},l=function(){};const p=new Promise((function(e,r){s=e,l=r}));return a||"Number"!==e.getType(u)||(a=u,u=""),a||c||"Function"!=e.getType(u)&&"AsyncFunction"!=e.getType(u)||(c=u,u="",a=null),c||(c=function(e,r){if(e)return l(e);s(r)}),e.isReadableStream(n)?(function(n,u){const a=[];a.push(i.postFormData("https://www.facebook.com/profile/picture/upload/",o.jar,{profile_id:o.i_userID||o.userID,photo_source:57,av:o.i_userID||o.userID,file:n},{}).then(e.parseAndCheckLogin(o,i)).then((function(e){if(e.error)throw e;return e}))),t.all(a).then((function(e){u(null,e)})).catch((function(e){return r.error("handleUpload",e),u(e)}))}(n,(function(t,n){if(t)return c(t);const s={av:o.i_userID||o.userID,fb_api_req_friendly_name:"ProfileCometProfilePictureSetMutation",fb_api_caller_class:"RelayModern",doc_id:"5066134240065849",variables:JSON.stringify({input:{caption:u,existing_photo_id:n[0].payload.fbid,expiration_time:a,profile_id:o.i_userID||o.userID,profile_pic_method:"EXISTING",profile_pic_source:"TIMELINE",scaled_crop_rect:{height:1,width:1,x:0,y:0},skip_cropping:!0,actor_id:o.i_userID||o.userID,client_mutation_id:Math.round(19*Math.random()).toString()},isPage:!1,isProfile:!0,scale:3})};i.post("https://www.facebook.com/api/graphql/",o.jar,s).then(e.parseAndCheckLogin(o,i)).then((function(e){if(e.errors)throw e;return c(null,e[0].data.profile_picture_set)})).catch((function(e){return r.error("changeAvatar",e),c(e)}))})),p):c("Image is not a readable stream")}};