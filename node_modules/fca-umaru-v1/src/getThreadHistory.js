const e=require("../utils"),t=require("npmlog");function a(e,t=""){if(e)return e;{const e=t.split(".").pop();return e===t?"":e}}function i(e){switch(e.__typename){case"MessageImage":return{type:"photo",ID:e.legacy_attachment_id,filename:e.filename,original_extension:a(e.original_extension,e.filename),thumbnailUrl:e.thumbnail.uri,previewUrl:e.preview.uri,previewWidth:e.preview.width,previewHeight:e.preview.height,largePreviewUrl:e.large_preview.uri,largePreviewHeight:e.large_preview.height,largePreviewWidth:e.large_preview.width,url:e.large_preview.uri,width:e.large_preview.width,height:e.large_preview.height,name:e.filename,attributionApp:e.attribution_app?{attributionAppID:e.attribution_app.id,name:e.attribution_app.name,logo:e.attribution_app.square_logo}:null};case"MessageAnimatedImage":return{type:"animated_image",ID:e.legacy_attachment_id,filename:e.filename,original_extension:a(e.original_extension,e.filename),previewUrl:e.preview_image.uri,previewWidth:e.preview_image.width,previewHeight:e.preview_image.height,url:e.animated_image.uri,width:e.animated_image.width,height:e.animated_image.height,thumbnailUrl:e.preview_image.uri,name:e.filename,facebookUrl:e.animated_image.uri,rawGifImage:e.animated_image.uri,animatedGifUrl:e.animated_image.uri,animatedGifPreviewUrl:e.preview_image.uri,animatedWebpUrl:e.animated_image.uri,animatedWebpPreviewUrl:e.preview_image.uri,attributionApp:e.attribution_app?{attributionAppID:e.attribution_app.id,name:e.attribution_app.name,logo:e.attribution_app.square_logo}:null};case"MessageVideo":return{type:"video",ID:e.legacy_attachment_id,filename:e.filename,original_extension:a(e.original_extension,e.filename),duration:e.playable_duration_in_ms,thumbnailUrl:e.large_image.uri,previewUrl:e.large_image.uri,previewWidth:e.large_image.width,previewHeight:e.large_image.height,url:e.playable_url,width:e.original_dimensions.x,height:e.original_dimensions.y,videoType:e.video_type.toLowerCase()};case"MessageFile":return{type:"file",ID:e.message_file_fbid,filename:e.filename,original_extension:a(e.original_extension,e.filename),url:e.url,isMalicious:e.is_malicious,contentType:e.content_type,name:e.filename,mimeType:"",fileSize:-1};case"MessageAudio":return{type:"audio",ID:e.url_shimhash,filename:e.filename,original_extension:a(e.original_extension,e.filename),duration:e.playable_duration_in_ms,audioType:e.audio_type,url:e.playable_url,isVoiceMail:e.is_voicemail};default:return{error:"Don't know about attachment type "+e.__typename}}}function n(e){return{reaction:e.reaction,userID:e.user.id}}function r(e){if(null==e)return{};switch(e.__typename){case"ThemeColorExtensibleMessageAdminText":return{color:e.theme_color};case"ThreadNicknameExtensibleMessageAdminText":return{nickname:e.nickname,participantID:e.participant_id};case"ThreadIconExtensibleMessageAdminText":return{threadIcon:e.thread_icon};case"InstantGameUpdateExtensibleMessageAdminText":return{gameID:null==e.game?null:e.game.id,update_type:e.update_type,collapsed_text:e.collapsed_text,expanded_text:e.expanded_text,instant_game_update_data:e.instant_game_update_data};case"GameScoreExtensibleMessageAdminText":return{game_type:e.game_type};case"RtcCallLogExtensibleMessageAdminText":return{event:e.event,is_video_call:e.is_video_call,server_info_data:e.server_info_data};case"GroupPollExtensibleMessageAdminText":return{event_type:e.event_type,total_count:e.total_count,question:e.question};case"AcceptPendingThreadExtensibleMessageAdminText":return{accepter_id:e.accepter_id,requester_id:e.requester_id};case"ConfirmFriendRequestExtensibleMessageAdminText":return{friend_request_recipient:e.friend_request_recipient,friend_request_sender:e.friend_request_sender};case"AddContactExtensibleMessageAdminText":return{contact_added_id:e.contact_added_id,contact_adder_id:e.contact_adder_id};case"AdExtensibleMessageAdminText":return{ad_client_token:e.ad_client_token,ad_id:e.ad_id,ad_preferences_link:e.ad_preferences_link,ad_properties:e.ad_properties};case"ParticipantJoinedGroupCallExtensibleMessageAdminText":case"ThreadEphemeralTtlModeExtensibleMessageAdminText":case"StartedSharingVideoExtensibleMessageAdminText":case"LightweightEventCreateExtensibleMessageAdminText":case"LightweightEventNotifyExtensibleMessageAdminText":case"LightweightEventNotifyBeforeEventExtensibleMessageAdminText":case"LightweightEventUpdateTitleExtensibleMessageAdminText":case"LightweightEventUpdateTimeExtensibleMessageAdminText":case"LightweightEventUpdateLocationExtensibleMessageAdminText":case"LightweightEventDeleteExtensibleMessageAdminText":return{};default:return{error:"Don't know what to with event data type "+e.__typename}}}module.exports=function(a,s,m){return function(s,d,_,l){let o=function(){},p=function(){};const g=new Promise((function(e,t){o=e,p=t}));l||(l=function(e,t){if(e)return p(e);o(t)});const c={av:m.globalOptions.pageID,queries:JSON.stringify({o0:{doc_id:"1498317363570230",query_params:{id:s,message_limit:d,load_messages:1,load_read_receipts:!1,before:_}}})};return a.post("https://www.facebook.com/api/graphqlbatch/",m.jar,c).then(e.parseAndCheckLogin(m,a)).then((function(t){if(t.error)throw t;if(0!==t[t.length-1].error_results)throw new Error("There was an error_result.");l(null,function(t){const a=t.o0.data.message_thread,s=a.thread_key.thread_fbid?a.thread_key.thread_fbid:a.thread_key.other_user_id;return a.messages.nodes.map((function(t){switch(t.__typename){case"UserMessage":var m;t.sticker&&(m=[{type:"sticker",ID:t.sticker.id,url:t.sticker.url,packID:t.sticker.pack?t.sticker.pack.id:null,spriteUrl:t.sticker.sprite_image,spriteUrl2x:t.sticker.sprite_image_2x,width:t.sticker.width,height:t.sticker.height,caption:t.snippet,description:t.sticker.label,frameCount:t.sticker.frame_count,frameRate:t.sticker.frame_rate,framesPerRow:t.sticker.frames_per_row,framesPerCol:t.sticker.frames_per_col,stickerID:t.sticker.id,spriteURI:t.sticker.sprite_image,spriteURI2x:t.sticker.sprite_image_2x}]);var d={};return null!==t.message&&t.message.ranges.forEach((e=>{d[e.entity.id]=t.message.text.substr(e.offset,e.length)})),{type:"message",attachments:m||(t.blob_attachments&&t.blob_attachments.length>0?t.blob_attachments.map(i):t.extensible_attachment?[(_=t.extensible_attachment,_.story_attachment?{type:"share",ID:_.legacy_attachment_id,url:_.story_attachment.url,title:_.story_attachment.title_with_entities.text,description:_.story_attachment.description&&_.story_attachment.description.text,source:null==_.story_attachment.source?null:_.story_attachment.source.text,image:null==_.story_attachment.media||null==_.story_attachment.media.animated_image&&null==_.story_attachment.media.image?null:(_.story_attachment.media.animated_image||_.story_attachment.media.image).uri,width:null==_.story_attachment.media||null==_.story_attachment.media.animated_image&&null==_.story_attachment.media.image?null:(_.story_attachment.media.animated_image||_.story_attachment.media.image).width,height:null==_.story_attachment.media||null==_.story_attachment.media.animated_image&&null==_.story_attachment.media.image?null:(_.story_attachment.media.animated_image||_.story_attachment.media.image).height,playable:null==_.story_attachment.media?null:_.story_attachment.media.is_playable,duration:null==_.story_attachment.media?null:_.story_attachment.media.playable_duration_in_ms,playableUrl:null==_.story_attachment.media?null:_.story_attachment.media.playable_url,subattachments:_.story_attachment.subattachments,properties:_.story_attachment.properties.reduce((function(e,t){return e[t.key]=t.value.text,e}),{}),animatedImageSize:"",facebookUrl:"",styleList:"",target:"",thumbnailUrl:null==_.story_attachment.media||null==_.story_attachment.media.animated_image&&null==_.story_attachment.media.image?null:(_.story_attachment.media.animated_image||_.story_attachment.media.image).uri,thumbnailWidth:null==_.story_attachment.media||null==_.story_attachment.media.animated_image&&null==_.story_attachment.media.image?null:(_.story_attachment.media.animated_image||_.story_attachment.media.image).width,thumbnailHeight:null==_.story_attachment.media||null==_.story_attachment.media.animated_image&&null==_.story_attachment.media.image?null:(_.story_attachment.media.animated_image||_.story_attachment.media.image).height}:{error:"Don't know what to do with extensible_attachment."})]:[]),body:null!==t.message?t.message.text:"",isGroup:"GROUP"===a.thread_type,messageID:t.message_id,senderID:t.message_sender.id,threadID:s,timestamp:t.timestamp_precise,mentions:d,isUnread:t.unread,messageReactions:t.message_reactions?t.message_reactions.map(n):null,isSponsored:t.is_sponsored,snippet:t.snippet};case"ThreadNameMessage":return{type:"event",messageID:t.message_id,threadID:s,isGroup:"GROUP"===a.thread_type,senderID:t.message_sender.id,timestamp:t.timestamp_precise,eventType:"change_thread_name",snippet:t.snippet,eventData:{threadName:t.thread_name},author:t.message_sender.id,logMessageType:"log:thread-name",logMessageData:{name:t.thread_name}};case"ThreadImageMessage":return{type:"event",messageID:t.message_id,threadID:s,isGroup:"GROUP"===a.thread_type,senderID:t.message_sender.id,timestamp:t.timestamp_precise,eventType:"change_thread_image",snippet:t.snippet,eventData:null==t.image_with_metadata?{}:{threadImage:{attachmentID:t.image_with_metadata.legacy_attachment_id,width:t.image_with_metadata.original_dimensions.x,height:t.image_with_metadata.original_dimensions.y,url:t.image_with_metadata.preview.uri}},logMessageType:"log:thread-icon",logMessageData:{thread_icon:t.image_with_metadata?t.image_with_metadata.preview.uri:null}};case"ParticipantLeftMessage":return{type:"event",messageID:t.message_id,threadID:s,isGroup:"GROUP"===a.thread_type,senderID:t.message_sender.id,timestamp:t.timestamp_precise,eventType:"remove_participants",snippet:t.snippet,eventData:{participantsRemoved:t.participants_removed.map((function(e){return e.id}))},logMessageType:"log:unsubscribe",logMessageData:{leftParticipantFbId:t.participants_removed.map((function(e){return e.id}))}};case"ParticipantsAddedMessage":return{type:"event",messageID:t.message_id,threadID:s,isGroup:"GROUP"===a.thread_type,senderID:t.message_sender.id,timestamp:t.timestamp_precise,eventType:"add_participants",snippet:t.snippet,eventData:{participantsAdded:t.participants_added.map((function(e){return e.id}))},logMessageType:"log:subscribe",logMessageData:{addedParticipants:t.participants_added.map((function(e){return e.id}))}};case"VideoCallMessage":return{type:"event",messageID:t.message_id,threadID:s,isGroup:"GROUP"===a.thread_type,senderID:t.message_sender.id,timestamp:t.timestamp_precise,eventType:"video_call",snippet:t.snippet,logMessageType:"other"};case"VoiceCallMessage":return{type:"event",messageID:t.message_id,threadID:s,isGroup:"GROUP"===a.thread_type,senderID:t.message_sender.id,timestamp:t.timestamp_precise,eventType:"voice_call",snippet:t.snippet,logMessageType:"other"};case"GenericAdminTextMessage":return{type:"event",messageID:t.message_id,threadID:s,isGroup:"GROUP"===a.thread_type,senderID:t.message_sender.id,timestamp:t.timestamp_precise,snippet:t.snippet,eventType:t.extensible_message_admin_text_type.toLowerCase(),eventData:r(t.extensible_message_admin_text),logMessageType:e.getAdminTextMessageType(t.extensible_message_admin_text_type),logMessageData:t.extensible_message_admin_text};default:return{error:"Don't know about message type "+t.__typename}}var _}))}(t[0]))})).catch((function(e){return t.error("getThreadHistoryGraphQL",e),l(e)})),g}};