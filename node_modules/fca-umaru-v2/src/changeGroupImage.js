const e=require("../utils"),t=require("npmlog"),r=require("bluebird");module.exports=function(a,n,i){return function(n,o,s){if(!s&&("Function"===e.getType(o)||"AsyncFunction"===e.getType(o)))throw{error:"please pass a threadID as a second argument."};if(!e.isReadableStream(n))throw{error:"please pass a readable stream as a first argument."};let u=function(){},c=function(){};const _=new Promise((function(e,t){u=e,c=t}));s||(s=function(e){if(e)return c(e);u()});const d=e.generateOfflineThreadingID(),m={client:"mercury",action_type:"ma-type:log-message",author:"fbid:"+(i.i_userID||i.userID),author_email:"",ephemeral_ttl_mode:"0",is_filtered_content:!1,is_filtered_content_account:!1,is_filtered_content_bh:!1,is_filtered_content_invalid_app:!1,is_filtered_content_quasar:!1,is_forward:!1,is_spoof_warning:!1,is_unread:!1,log_message_type:"log:thread-image",manual_retry_cnt:"0",message_id:d,offline_threading_id:d,source:"source:chat:web","source_tags[0]":"source:chat",status:"0",thread_fbid:o,thread_id:"",timestamp:Date.now(),timestamp_absolute:"Today",timestamp_relative:e.generateTimestampRelative(),timestamp_time_passed:"0"};return function(n,o){const s=[];s.push(a.postFormData("https://upload.facebook.com/ajax/mercury/upload.php",i.jar,{images_only:"true","attachment[]":n},{}).then(e.parseAndCheckLogin(i,a)).then((function(e){if(e.error)throw e;return e.payload.metadata[0]}))),r.all(s).then((function(e){o(null,e)})).catch((function(e){return t.error("handleUpload",e),o(e)}))}(n,(function(r,n){if(r)return s(r);m.thread_image_id=n[0].image_id,m.thread_id=o,a.post("https://www.facebook.com/messaging/set_thread_image/",i.jar,m).then(e.parseAndCheckLogin(i,a)).then((function(e){if(e.error)throw e;return s()})).catch((function(e){return t.error("changeGroupImage",e),s(e)}))})),_}};