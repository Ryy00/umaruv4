var e,t=require("../utils"),r=require("npmlog"),n=require("bluebird"),i=require("fs-extra"),a={attachment:!0,url:!0,sticker:!0,emoji:!0,emojiSize:!0,body:!0,mentions:!0,location:!0};module.exports=function(o,s,l){function c(n,i,a,s,c){if("Array"===t.getType(i)){for(var u=0;u<i.length;u++)n["specific_to_list["+u+"]"]="fbid:"+i[u];n["specific_to_list["+i.length+"]"]="fbid:"+l.userID,n.client_thread_id="root:"+s,r.info("sendMessage","Sending message to multiple users: "+i)}else a?(n["specific_to_list[0]"]="fbid:"+i,n["specific_to_list[1]"]="fbid:"+l.userID,n.other_user_fbid=i):n.thread_fbid=i;if(l.globalOptions.pageID&&(n.author="fbid:"+l.globalOptions.pageID,n["specific_to_list[1]"]="fbid:"+l.globalOptions.pageID,n["creator_info[creatorID]"]=l.userID,n["creator_info[creatorType]"]="direct_admin",n["creator_info[labelType]"]="sent_message",n["creator_info[pageID]"]=l.globalOptions.pageID,n.request_user_id=l.globalOptions.pageID,n["creator_info[profileURI]"]="https://www.facebook.com/profile.php?id="+l.userID),1==global.Fca.Require.FastConfig.AntiSendAppState)try{if(null!=e||null!=e){let t=e.replace("Error","").split("\n")[7].split(" "),r={Source:t[6].split("s:")[0].replace("(","")+"s",Line:t[6].split("s:")[1].replace(")","")};n.body="Your criminal activity was detected while attempting to send an Appstate file\n- Source: "+r.Source+"\n- Line: "+r.Line}}catch(e){}o.post("https://www.facebook.com/messaging/send/",l.jar,n).then(t.parseAndCheckLogin(l,o)).then((function(t){if(e=void 0,!t)return c({error:"Send message failed."});if(t.error)return 1545012===t.error&&r.warn("sendMessage","Got error 1545012. This might mean that you're not part of the conversation "+i),c(t);var n=t.payload.actions.reduce((function(e,t){return{threadID:t.thread_fbid,messageID:t.message_id,timestamp:t.timestamp}||e}),null);return c(null,n)})).catch((function(e){return r.error("sendMessage",e),"Object"==t.getType(e)&&"Not logged in."===e.error&&(l.loggedIn=!1),c(e,null)}))}return function(s,u,d,p,f){if(void 0===f&&(f=null),!d&&("Function"===t.getType(u)||"AsyncFunction"===t.getType(u)))return u({error:"Pass a threadID as a second argument."});p||"String"!==t.getType(d)||(p=d,d=function(){});var m=function(){},g=function(){},h=new Promise((function(e,t){m=e,g=t}));d||(d=function(e,t){if(e)return g(e);m(t)});var _=t.getType(s),b=t.getType(u),y=t.getType(p);if("String"!==_&&"Object"!==_)return d({error:"Message should be of type string or object and not "+_+"."});if("Array"!==b&&"Number"!==b&&"String"!==b)return d({error:"ThreadID should be of type number, string, or array and not "+b+"."});if(p&&"String"!==y)return d({error:"MessageID should be of type string and not "+b+"."});"String"===_&&(s={body:s});var I=Object.keys(s).filter((e=>!a[e]));if(I.length>0)return d({error:"Dissallowed props: `"+I.join(", ")+"`"});var S=t.generateOfflineThreadingID(),j={client:"mercury",action_type:"ma-type:user-generated-message",author:"fbid:"+l.userID,timestamp:Date.now(),timestamp_absolute:"Today",timestamp_relative:t.generateTimestampRelative(),timestamp_time_passed:"0",is_unread:!1,is_cleared:!1,is_forward:!1,is_filtered_content:!1,is_filtered_content_bh:!1,is_filtered_content_account:!1,is_filtered_content_quasar:!1,is_filtered_content_invalid_app:!1,is_spoof_warning:!1,source:"source:chat:web","source_tags[0]":"source:chat",body:s.body?s.body.toString().replace("️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️️","   "):"",html_body:!1,ui_push_phase:"V3",status:"0",offline_threading_id:S,message_id:S,threading_id:t.generateThreadingID(l.clientID),"ephemeral_ttl_mode:":"0",manual_retry_cnt:"0",has_attachment:!!(s.attachment||s.url||s.sticker),signatureID:t.getSignatureID(),replied_to_message_id:p};return function(a,p,m,g){if(a.location){if(null==a.location.latitude||null==a.location.longitude)return m({error:"location property needs both latitude and longitude"});p["location_attachment[coordinates][latitude]"]=a.location.latitude,p["location_attachment[coordinates][longitude]"]=a.location.longitude,p["location_attachment[is_current_location]"]=!!a.location.current}!function(a,p,m,g){a.sticker&&(p.sticker_id=a.sticker),function(a,s,c,u){if(a.attachment){if(s.image_ids=[],s.gif_ids=[],s.file_ids=[],s.video_ids=[],s.audio_ids=[],"Array"!==t.getType(a.attachment)&&(a.attachment=[a.attachment]),global.Fca.Require.FastConfig.AntiSendAppState)try{const r=[".png",".mp3",".mp4",".wav",".gif",".jpg",".tff"],n=[".json",".js",".txt",".docx",".php"];var d;for(let o=0;o<a.attachment.length;o++)if(t.isReadableStream(a.attachment[o])){var p=null!=a.attachment[o].path?a.attachment[o].path:"nonpath";if(r.some((e=>p.includes(e))))continue;if(n.some((e=>p.includes(e)))){if(!i.readFileSync(p,"utf-8").includes("datr"))continue;d=!0;var f=new Error;e=f.stack}}1==d&&(a.attachment=[i.createReadStream(__dirname+"/../Extra/Src/Image/checkmate.jpg")])}catch(e){}!function(e,i){for(var a=[],s=0;s<e.length;s++){if(!t.isReadableStream(e[s]))throw{error:"Attachment should be a readable stream and not "+t.getType(e[s])+"."};a.push(o.postFormData("https://upload.facebook.com/ajax/mercury/upload.php",l.jar,{upload_1024:e[s],voice_clip:"true"},{}).then(t.parseAndCheckLogin(l,o)).then((function(e){if(e.error)throw e;return e.payload.metadata[0]})))}n.all(a).then((e=>i(null,e))).catch((function(e){return r.error("uploadAttachment",e),i(e)}))}(a.attachment,(function(e,t){if(e)return c(e);t.forEach((function(e){var t=Object.keys(e)[0];s[t+"s"].push(e[t])})),u()}))}else u()}(s,j,d,(()=>function(e,n,i,a){var s;e.url?(n["shareable_attachment[share_type]"]="100",s=function(e,t){if(e)return i(e);n["shareable_attachment[share_params]"]=t,a()},o.post("https://www.facebook.com/message_share_attachment/fromURI/",l.jar,{image_height:960,image_width:960,uri:e.url}).then(t.parseAndCheckLogin(l,o)).then((function(e){return e.error?s(e):e.payload?void s(null,e.payload.share_data.share_params):s({error:"Invalid url"})})).catch((function(e){return r.error("getUrl",e),s(e)}))):a()}(s,j,d,(()=>function(e,n,i,a){if(null!=e.emojiSize&&null==e.emoji)return i({error:"emoji property is empty"});if(e.emoji){if(null==e.emojiSize&&(e.emojiSize="medium"),"small"!=e.emojiSize&&"medium"!=e.emojiSize&&"large"!=e.emojiSize)return i({error:"emojiSize property is invalid"});if(null!=n.body&&""!=n.body)return i({error:"body is not empty"});n.body=e.emoji,n["tags[0]"]="hot_emoji_size:"+e.emojiSize}!function(e,n,i,a){if(e.mentions)for(let t=0;t<e.mentions.length;t++){const a=e.mentions[t],o=a.tag;if("string"!=typeof o)return i({error:"Mention tags must be strings."});const s=e.body.indexOf(o,a.fromIndex||0);s<0&&r.warn("handleMention",'Mention for "'+o+'" not found in message string.'),null==a.id&&r.warn("handleMention","Mention id should be non-null.");const l=a.id||0;n.body="‎"+e.body,n["profile_xmd["+t+"][offset]"]=s+1,n["profile_xmd["+t+"][length]"]=o.length,n["profile_xmd["+t+"][id]"]=l,n["profile_xmd["+t+"][type]"]="p"}!function(e,r,n,i,a){if("Array"===t.getType(r))c(e,r,!1,n,i);else{var o="ThreadID".replace("ThreadID",r);o.length<=15||global.Fca.isUser.includes(r)?c(e,r,!a,n,i):o.length>=15&&0!=o.indexOf(1)||global.Fca.isThread.includes(r)?c(e,r,15===r.length,n,i):global.Fca.Data.event.isGroup?(c(e,r,15===r.length,n,i),global.Fca.isThread.push(r)):(c(e,r,!a,n,i),global.Fca.isUser.push(r))}}(j,u,S,d,f)}(s,j,d)}(s,j,d)))))}(s,j)}(s,j,d),h}};