var e=require("url"),t=require("npmlog");require("lodash");var a,r=require("stream"),i=require("bluebird"),n=require("querystring"),s=i.promisify(require("request").defaults({jar:!0}));function o(e,t,a,r){var i={"Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.facebook.com/",Host:e.replace("https://","").split("/")[0],Origin:"https://www.facebook.com","user-agent":t.userAgent||"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36",Connection:"keep-alive","sec-fetch-site":"same-origin","sec-fetch-mode":"cors"};return r&&Object.assign(i,r),a&&a.region&&(i["X-MSGR-Region"]=a.region),i}function d(e,t,a,r,i){if("Object"===M(a))for(var n in a)a.hasOwnProperty(n)&&"Object"===M(a[n])&&(a[n]=JSON.stringify(a[n]));var d={headers:o(e,r,i),timeout:6e4,qs:a,url:e,method:"GET",jar:t,gzip:!0};return s(d).then((function(e){return e}))}function m(e,t,a,r,i,n){var d={headers:o(e,r),timeout:6e4,url:e,method:"POST",form:a,jar:t,gzip:!0};return s(d).then((function(e){return e}))}function c(e,t,a,r,i,n){var d=o(e,i,n);return d["Content-Type"]="multipart/form-data",s({headers:d,timeout:6e4,url:e,method:"POST",formData:a,qs:r,jar:t,gzip:!0}).then((function(e){return e}))}var l={},h={_:"%",A:"%2",B:"000",C:"%7d",D:"%7b%22",E:"%2c%22",F:"%22%3a",G:"%2c%22ut%22%3a1",H:"%2c%22bls%22%3a",I:"%2c%22n%22%3a%22%",J:"%22%3a%7b%22i%22%3a0%7d",K:"%2c%22pt%22%3a0%2c%22vis%22%3a",L:"%2c%22ch%22%3a%7b%22h%22%3a%22",M:"%7b%22v%22%3a2%2c%22time%22%3a1",N:".channel%22%2c%22sub%22%3a%5b",O:"%2c%22sb%22%3a1%2c%22t%22%3a%5b",P:"%2c%22ud%22%3a100%2c%22lc%22%3a0",Q:"%5d%2c%22f%22%3anull%2c%22uct%22%3a",R:".channel%22%2c%22sub%22%3a%5b1%5d",S:"%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a",T:"%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a",U:"%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a",V:"%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a",W:"%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a",X:"%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1",Y:"%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a",Z:"%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a"};function u(t,a){a=a||{id:"",image_data:{}};var r=(t=t.mercury?t.mercury:t).blob_attachment,i=r&&r.__typename?r.__typename:t.attach_type;switch(!i&&t.sticker_attachment?(i="StickerAttachment",r=t.sticker_attachment):!i&&t.extensible_attachment&&(i=t.extensible_attachment.story_attachment&&t.extensible_attachment.story_attachment.target&&t.extensible_attachment.story_attachment.target.__typename&&"MessageLocation"===t.extensible_attachment.story_attachment.target.__typename?"MessageLocation":"ExtensibleAttachment",r=t.extensible_attachment),i){case"sticker":return{type:"sticker",ID:t.metadata.stickerID.toString(),url:t.url,packID:t.metadata.packID.toString(),spriteUrl:t.metadata.spriteURI,spriteUrl2x:t.metadata.spriteURI2x,width:t.metadata.width,height:t.metadata.height,caption:a.caption,description:a.description,frameCount:t.metadata.frameCount,frameRate:t.metadata.frameRate,framesPerRow:t.metadata.framesPerRow,framesPerCol:t.metadata.framesPerCol,stickerID:t.metadata.stickerID.toString(),spriteURI:t.metadata.spriteURI,spriteURI2x:t.metadata.spriteURI2x};case"file":return{type:"file",filename:t.name,ID:a.id.toString(),url:t.url,isMalicious:a.is_malicious,contentType:a.mime_type,name:t.name,mimeType:a.mime_type,fileSize:a.file_size};case"photo":return{type:"photo",ID:t.metadata.fbid.toString(),filename:t.fileName,thumbnailUrl:t.thumbnail_url,previewUrl:t.preview_url,previewWidth:t.preview_width,previewHeight:t.preview_height,largePreviewUrl:t.large_preview_url,largePreviewWidth:t.large_preview_width,largePreviewHeight:t.large_preview_height,url:t.metadata.url,width:t.metadata.dimensions.split(",")[0],height:t.metadata.dimensions.split(",")[1],name:t.fileName};case"animated_image":return{type:"animated_image",ID:a.id.toString(),filename:a.filename,previewUrl:t.preview_url,previewWidth:t.preview_width,previewHeight:t.preview_height,url:a.image_data.url,width:a.image_data.width,height:a.image_data.height,name:t.name,facebookUrl:t.url,thumbnailUrl:t.thumbnail_url,mimeType:a.mime_type,rawGifImage:a.image_data.raw_gif_image,rawWebpImage:a.image_data.raw_webp_image,animatedGifUrl:a.image_data.animated_gif_url,animatedGifPreviewUrl:a.image_data.animated_gif_preview_url,animatedWebpUrl:a.image_data.animated_webp_url,animatedWebpPreviewUrl:a.image_data.animated_webp_preview_url};case"share":return{type:"share",ID:t.share.share_id.toString(),url:a.href,title:t.share.title,description:t.share.description,source:t.share.source,image:t.share.media.image,width:t.share.media.image_size.width,height:t.share.media.image_size.height,playable:t.share.media.playable,duration:t.share.media.duration,subattachments:t.share.subattachments,properties:{},animatedImageSize:t.share.media.animated_image_size,facebookUrl:t.share.uri,target:t.share.target,styleList:t.share.style_list};case"video":return{type:"video",ID:t.metadata.fbid.toString(),filename:t.name,previewUrl:t.preview_url,previewWidth:t.preview_width,previewHeight:t.preview_height,url:t.url,width:t.metadata.dimensions.width,height:t.metadata.dimensions.height,duration:t.metadata.duration,videoType:"unknown",thumbnailUrl:t.thumbnail_url};case"error":return{type:"error",attachment1:t,attachment2:a};case"MessageImage":return{type:"photo",ID:r.legacy_attachment_id,filename:r.filename,thumbnailUrl:r.thumbnail.uri,previewUrl:r.preview.uri,previewWidth:r.preview.width,previewHeight:r.preview.height,largePreviewUrl:r.large_preview.uri,largePreviewWidth:r.large_preview.width,largePreviewHeight:r.large_preview.height,url:r.large_preview.uri,width:r.original_dimensions.x,height:r.original_dimensions.y,name:r.filename};case"MessageAnimatedImage":return{type:"animated_image",ID:r.legacy_attachment_id,filename:r.filename,previewUrl:r.preview_image.uri,previewWidth:r.preview_image.width,previewHeight:r.preview_image.height,url:r.animated_image.uri,width:r.animated_image.width,height:r.animated_image.height,thumbnailUrl:r.preview_image.uri,name:r.filename,facebookUrl:r.animated_image.uri,rawGifImage:r.animated_image.uri,animatedGifUrl:r.animated_image.uri,animatedGifPreviewUrl:r.preview_image.uri,animatedWebpUrl:r.animated_image.uri,animatedWebpPreviewUrl:r.preview_image.uri};case"MessageVideo":return{type:"video",filename:r.filename,ID:r.legacy_attachment_id,previewUrl:r.large_image.uri,previewWidth:r.large_image.width,previewHeight:r.large_image.height,url:r.playable_url,width:r.original_dimensions.x,height:r.original_dimensions.y,duration:r.playable_duration_in_ms,videoType:r.video_type.toLowerCase(),thumbnailUrl:r.large_image.uri};case"MessageAudio":return{type:"audio",filename:r.filename,ID:r.url_shimhash,audioType:r.audio_type,duration:r.playable_duration_in_ms,url:r.playable_url,isVoiceMail:r.is_voicemail};case"StickerAttachment":return{type:"sticker",ID:r.id,url:r.url,packID:r.pack?r.pack.id:null,spriteUrl:r.sprite_image,spriteUrl2x:r.sprite_image_2x,width:r.width,height:r.height,caption:r.label,description:r.label,frameCount:r.frame_count,frameRate:r.frame_rate,framesPerRow:r.frames_per_row,framesPerCol:r.frames_per_column,stickerID:r.id,spriteURI:r.sprite_image,spriteURI2x:r.sprite_image_2x};case"MessageLocation":var s,o,d,m,c,l=r.story_attachment.url,h=r.story_attachment.media,u=n.parse(e.parse(l).query).u,g=n.parse(e.parse(u).query).where1,p=g.split(", ");try{s=Number.parseFloat(p[0]),o=Number.parseFloat(p[1])}catch(e){}return h&&h.image&&(d=h.image.uri,m=h.image.width,c=h.image.height),{type:"location",ID:r.legacy_attachment_id,latitude:s,longitude:o,image:d,width:m,height:c,url:u||l,address:g,facebookUrl:r.story_attachment.url,target:r.story_attachment.target,styleList:r.story_attachment.style_list};case"ExtensibleAttachment":return{type:"share",ID:r.legacy_attachment_id,url:r.story_attachment.url,title:r.story_attachment.title_with_entities.text,description:r.story_attachment.description&&r.story_attachment.description.text,source:r.story_attachment.source?r.story_attachment.source.text:null,image:r.story_attachment.media&&r.story_attachment.media.image&&r.story_attachment.media.image.uri,width:r.story_attachment.media&&r.story_attachment.media.image&&r.story_attachment.media.image.width,height:r.story_attachment.media&&r.story_attachment.media.image&&r.story_attachment.media.image.height,playable:r.story_attachment.media&&r.story_attachment.media.is_playable,duration:r.story_attachment.media&&r.story_attachment.media.playable_duration_in_ms,playableUrl:null==r.story_attachment.media?null:r.story_attachment.media.playable_url,subattachments:r.story_attachment.subattachments,properties:r.story_attachment.properties.reduce((function(e,t){return e[t.key]=t.value.text,e}),{}),facebookUrl:r.story_attachment.url,target:r.story_attachment.target,styleList:r.story_attachment.style_list};case"MessageFile":return{type:"file",filename:r.filename,ID:r.message_file_fbid,url:r.url,isMalicious:r.is_malicious,contentType:r.content_type,name:r.filename,mimeType:"",fileSize:-1};default:throw new Error("unrecognized attach_file of type "+i+"`"+JSON.stringify(t,null,4)+" attachment2: "+JSON.stringify(a,null,4)+"`")}}function g(e){return null!=e&&null!=e?e.replace(/(fb)?id[:.]/,""):e}function p(e){var t,a,r,i,n=e.message?e.message:e,s={type:"message",senderName:n.sender_name,senderID:g(n.sender_fbid.toString()),participantNames:n.group_thread_info?n.group_thread_info.participant_names:[n.sender_name.split(" ")[0]],participantIDs:n.group_thread_info?n.group_thread_info.participant_ids.map((function(e){return g(e.toString())})):[g(n.sender_fbid)],body:n.body||"",threadID:g((n.thread_fbid||n.other_user_fbid).toString()),threadName:n.group_thread_info?n.group_thread_info.name:n.sender_name,location:n.coordinates?n.coordinates:null,messageID:n.mid?n.mid.toString():n.message_id,attachments:(t=n.attachments,a=n.attachmentIds,r=n.attachment_map,i=n.share_map,r=i||r,t?t.map((function(e,t){return r&&a&&r[a[t]]?u(e,r[a[t]]):u(e)})):[]),timestamp:n.timestamp,timestampAbsolute:n.timestamp_absolute,timestampRelative:n.timestamp_relative,timestampDatetime:n.timestamp_datetime,tags:n.tags,reactions:n.reactions?n.reactions:[],isUnread:n.is_unread};return"pages_messaging"===e.type&&(s.pageID=e.realtime_viewer_fbid.toString()),s.isGroup=s.participantIDs.length>2,s}function _(e){switch(e.type){case"joinable_group_link_mode_change":return"log:link-status";case"magic_words":return"log:magic-words";case"change_thread_theme":return"log:thread-color";case"change_thread_icon":return"log:thread-icon";case"change_thread_nickname":return"log:user-nickname";case"change_thread_admins":return"log:thread-admins";case"group_poll":return"log:thread-poll";case"change_thread_approval_mode":return"log:thread-approval-mode";case"messenger_call_log":case"participant_joined_group_call":return"log:thread-call";case"pin_messages_v2":return"log:thread-pinned"}}function f(e){var t=["LAN","HÂN","LINH","MAI","HOA","THU","BĂNG","MỸ","CHÂU","THẢO","THOA","MẪN","THÙY","THỦY","NGA","NGÂN","NGHI","THƯ","NGỌC","BÍCH","VÂN","DIỆP","CHI","TIÊN","XUÂN","GIANG","NHUNG","DUNG","NHƯ","YẾN","QUYÊN","YẾN","TƯỜNG","VY","PHƯƠNG","LIÊN","LAN","HÀ","MAI","ĐAN","HẠ","QUYÊN","LY","HÒA","OANH","HƯƠNG","HẰNG","QUỲNH","HẠNH","NHIÊN","NHẠN"],a=["ANH","THANH","TÂM","DƯƠNG","AN","LÂM","MIÊN","TÚ","LÂM","BẰNG","KHÁNH","NHẬT","VỸ",".",",","/","%","&","*","-","+"];try{var r,i=e.split(" ");if(" "==(e=i[i.length-1])||null==e)return"UNKNOWN";switch(t.includes(e.toUpperCase())){case!0:r=a.includes(e.toUpperCase())||["HƯNG","HUY","KHẢI","KHANG","KHOA","KHÔI","KIÊN","KIỆT","LONG","MINH","ÂN","BẢO","BÌNH","CƯỜNG","ĐẠT","ĐỨC","DŨNG","DUY","HOÀNG","HÙNG","HƯNG","NGHĨA","NGUYÊN","THẮNG","THIỆN","THỊNH","TÒA","TRIẾT","TRUNG","TRƯỜNG","TUẤN","NHÂN","VŨ","VINH","PHONG","PHÚC","QUÂN","QUANG","SƠN","TÀI","THẮNG","ĐĂNG","VĂN","VĨ","QUANG","MẠNH"].includes(e.toUpperCase())?["FEMALE","MALE"][Math.floor(2*Math.random())]:"FEMALE";break;case!1:r=a.includes(e.toUpperCase())||t.includes(e.toUpperCase())?["FEMALE","MALE"][Math.floor(2*Math.random())]:"MALE"}}catch(e){return"UNKNOWN"}return r||"UNKNOWN"}function b(e,t,a){var r=e.indexOf(t)+t.length;if(r<t.length)return"";var i=e.substring(r),n=i.indexOf(a);if(-1===n)throw Error("Could not find endTime `"+a+"` in the given string.");return i.substring(0,n)}function y(e){let t=e.replace(/for\s*\(\s*;\s*;\s*\)\s*;\s*/,"").split(/\}\r\n *\{/);return 1===t.length?t:"["+t.join("},{")+"]"}!function(){var e=[];for(var t in h)l[h[t]]=t,e.push(h[t]);e.reverse(),a=new RegExp(e.join("|"),"g")}();var I=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],w=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function v(e,t){return e[0]+"="+e[1]+"; Path="+e[3]+"; Domain="+t+".com"}function M(e){return Object.prototype.toString.call(e).slice(8,-1)}module.exports={isReadableStream:function(e){return e instanceof r.Stream&&("Function"===M(e._read)||"AsyncFunction"===M(e._read))&&"Object"===M(e._readableState)},get:d,post:m,postFormData:c,generateThreadingID:function(e){return"<"+Date.now()+":"+Math.floor(4294967295*Math.random())+"-"+e+"@mail.projektitan.com>"},generateOfflineThreadingID:function(){var e=Date.now(),t=("0000000000000000000000"+Math.floor(4294967295*Math.random()).toString(2)).slice(-22);return function(e){for(var t="";"0"!==e;){for(var a=0,r="",i=0;i<e.length;i++)(a=2*a+parseInt(e[i],10))>=10?(r+="1",a-=10):r+="0";t=a.toString()+t,e=r.slice(r.indexOf("1"))}return t}(e.toString(2)+t)},getGUID:function(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var a=Math.floor((e+16*Math.random())%16);return e=Math.floor(e/16),("x"==t?a:7&a|8).toString(16)}))},getFrom:b,makeParsable:y,arrToForm:function(e){return t=function(e){return e.name},a=function(e){return e.val},e.reduce((function(e,r){return e[t(r)]=a(r),e}),{});var t,a},getSignatureID:function(){return Math.floor(2147483648*Math.random()).toString(16)},getJar:s.jar,generateTimestampRelative:function(){var e=new Date;return e.getHours()+":"+function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}(e.getMinutes())},makeDefaults:function(e,t,a){for(var r=1,i=b(e,'name="fb_dtsg" value="','"'),n="2",s=0;s<i.length;s++)n+=i.charCodeAt(s);var o=b(e,'revision":',",");function l(e){var s={__user:t,__req:(r++).toString(36),__rev:o,__a:1,fb_dtsg:a.fb_dtsg?a.fb_dtsg:i,jazoest:a.ttstamp?a.ttstamp:n};if(!e)return s;for(var d in e)e.hasOwnProperty(d)&&(s[d]||(s[d]=e[d]));return s}return{get:function(e,t,r,i){return d(e,t,l(r),a.globalOptions,i||a)},post:function(e,t,r,i){return m(e,t,l(r),a.globalOptions)},postFormData:function(e,t,r,i,n){return c(e,t,l(r),l(i),a.globalOptions,n||a)}}},parseAndCheckLogin:function e(a,r,n){return null==n&&(n=0),function(s){return i.try((function(){if(t.verbose("parseAndCheckLogin",s.body),s.statusCode>=500&&s.statusCode<600){if(n>=5)throw{error:"Request retry failed. Check the `res` and `statusCode` property on this error.",statusCode:s.statusCode,res:s.body};n++;var o=Math.floor(5e3*Math.random());t.warn("parseAndCheckLogin","Got status code "+s.statusCode+" - "+n+". attempt to retry in "+o+" milliseconds...");var d=s.request.uri.protocol+"//"+s.request.uri.hostname+s.request.uri.pathname;return"multipart/form-data"===s.request.headers["Content-Type"].split(";")[0]?i.delay(o).then((()=>r.postFormData(d,a.jar,s.request.formData,{}))).then(e(a,r,n)):i.delay(o).then((()=>r.post(d,a.jar,s.request.formData))).then(e(a,r,n))}if(200!==s.statusCode)throw new Error("parseAndCheckLogin got status code: "+s.statusCode+". Bailing out of trying to parse response.");var m=null;try{m=JSON.parse(y(s.body))}catch(e){throw{error:"JSON.parse error. Check the `detail` property on this error.",detail:e,res:s.body}}if(m.redirect&&"GET"===s.request.method)return r.get(m.redirect,a.jar).then(e(a,r));if(m.jsmods&&m.jsmods.require&&Array.isArray(m.jsmods.require[0])&&"Cookie"===m.jsmods.require[0][0]){m.jsmods.require[0][3][0]=m.jsmods.require[0][3][0].replace("_js_","");var c=v(m.jsmods.require[0][3],"facebook"),l=v(m.jsmods.require[0][3],"messenger");a.jar.setCookie(c,"https://www.facebook.com"),a.jar.setCookie(l,"https://www.messenger.com")}if(m.jsmods&&Array.isArray(m.jsmods.require)){var h=m.jsmods.require;for(var u in h)if("DTSG"===h[u][0]&&"setToken"===h[u][1]){a.fb_dtsg=h[u][3][0],a.ttstamp="2";for(var g=0;g<a.fb_dtsg.length;g++)a.ttstamp+=a.fb_dtsg.charCodeAt(g)}}return 1357001===m.error?global.Fca.Require.FastConfig.AutoLogin?global.Fca.Require.logger.Warning(global.Fca.Require.Language.Index.AutoLogin,(function(){return global.Fca.Action("AutoLogin")})):global.Fca.Require.FastConfig.AutoLogin?void 0:global.Fca.Require.logger.Error(global.Fca.Require.Language.Index.ErrAppState):m}))}},getGender:f,getData_Path:function e(t,a,r){if(0===a.length&&null!=t)return t;if(null==t)return r;const i=a[0];if(null==i)return r;const n=a.slice(1);return e(t[i],n,r++)},setData_Path:function e(t,a,r){if(!a.length)return t;const i=a[0];let n=t[i];return n||(t[i]=r,n=t[i]),a.shift(),n=a.length?e(n,a,r):r,t},getPaths:function e(t,a=[]){let r=[];for(let i in t)"object"==typeof t[i]?r=r.concat(e(t[i],[...a,i])):r.push([...a,i]);return r},saveCookies:function(e){return function(t){return(t.headers["set-cookie"]||[]).forEach((function(t){t.indexOf(".facebook.com")>-1&&(e.setCookie(t,"https://www.facebook.com"),e.setCookie(t.replace(/domain=\.facebook\.com/,"domain=.messenger.com"),"https://www.messenger.com"))})),t}},getType:M,_formatAttachment:u,formatHistoryMessage:function(e){return"ma-type:log-message"===e.action_type?("log:generic-admin-text"===(i=(r=(t=e).message?t.message:t).log_message_type)?(a=r.log_message_data.untypedData,i=_(r.log_message_data.message_type)):a=r.log_message_data,Object.assign(p(r),{type:"event",logMessageType:i,logMessageData:a,logMessageBody:r.log_message_body})):p(e);var t,a,r,i},formatID:g,formatMessage:p,formatDeltaEvent:function(e){var t,a;switch(e.class){case"AdminTextMessage":t=_(e),a=e.untypedData;break;case"ThreadName":t="log:thread-name",a={name:e.name};break;case"ParticipantsAddedToGroupThread":t="log:subscribe",a={addedParticipants:e.addedParticipants};break;case"ParticipantLeftGroupThread":t="log:unsubscribe",a={leftParticipantFbId:e.leftParticipantFbId};break;case"UserLocation":t="log:user-location",a={Image:e.attachments[0].mercury.extensible_attachment.story_attachment.media.image,Location:e.attachments[0].mercury.extensible_attachment.story_attachment.target.location_title,coordinates:e.attachments[0].mercury.extensible_attachment.story_attachment.target.coordinate,url:e.attachments[0].mercury.extensible_attachment.story_attachment.url}}if(!0===g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()))switch(t){case"log:thread-color":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));t.emoji=a.theme_emoji||t.emoji,t.color=a.theme_color||t.color,r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}break;case"log:thread-icon":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));t.emoji=a.thread_icon||t.emoji,r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}break;case"log:user-nickname":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));t.nicknames[a.participant_id]=0==a.nickname.length?t.userInfo.find((e=>e.id==String(a.participant_id))).name:a.nickname,r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}break;case"log:thread-admins":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));switch(a.ADMIN_EVENT){case"add_admin":t.adminIDs.push({id:a.TARGET_ID});break;case"remove_admin":t.adminIDs=t.adminIDs.filter((e=>e.id!=a.TARGET_ID))}r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}break;case"log:thread-approval-mode":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));t.approvalMode=1!=t.approvalMode,r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}break;case"log:thread-name":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));t.threadName=a.name||g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}break;case"log:subscribe":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));for(let e of a.addedParticipants)t.userInfo.some((t=>t.id==e.userFbId))||(t.userInfo.push({id:e.userFbId,name:e.fullName,gender:f(e.fullName)}),t.participantIDs.push(e.userFbId));r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}break;case"log:unsubscribe":{let t=i(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()));t.participantIDs=t.participantIDs.filter((e=>e!=a.leftParticipantFbId)),t.userInfo=t.userInfo.filter((e=>e.id!=a.leftParticipantFbId)),t.adminIDs.some((e=>e.id==a.leftParticipantFbId))&&(t.adminIDs=t.adminIDs.filter((e=>e.id!=a.leftParticipantFbId))),r(g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),t)}}return{type:"event",threadID:g((e.messageMetadata.threadKey.threadFbId||e.messageMetadata.threadKey.otherUserFbId).toString()),logMessageType:t,logMessageData:a,logMessageBody:e.messageMetadata.adminText,author:e.messageMetadata.actorFbId,participantIDs:e.participants||[]}},formatDeltaMessage:function(e){for(var t=e.delta.messageMetadata,a=void 0===e.delta.data||void 0===e.delta.data.prng?[]:JSON.parse(e.delta.data.prng),r=a.map((e=>e.i)),i=a.map((e=>e.o)),n=a.map((e=>e.l)),s={},o=e.delta.body||"",d=""==o?[]:o.trim().split(/\s+/),m=0;m<r.length;m++)s[r[m]]=e.delta.body.substring(i[m],i[m]+n[m]);return{type:"message",senderID:g(t.actorFbId.toString()),threadID:g((t.threadKey.threadFbId||t.threadKey.otherUserFbId).toString()),messageID:t.messageId,args:d,body:o,attachments:(e.delta.attachments||[]).map((e=>u(e))),mentions:s,timestamp:t.timestamp,isGroup:!!t.threadKey.threadFbId,participantIDs:e.delta.participants||[]}},formatProxyPresence:function(e,t){return void 0===e.lat||void 0===e.p?null:{type:"presence",timestamp:1e3*e.lat,userID:t||"",statuses:e.p}},formatPresence:function(e,t){return{type:"presence",timestamp:1e3*e.la,userID:t||"",statuses:e.a}},formatTyp:function(e){return{isTyping:!!e.st,from:e.from.toString(),threadID:g((e.to||e.thread_fbid||e.from).toString()),fromMobile:!e.hasOwnProperty("from_mobile")||e.from_mobile,userID:(e.realtime_viewer_fbid||e.from).toString(),type:"typ"}},formatDeltaReadReceipt:function(e){return{reader:(e.threadKey.otherUserFbId||e.actorFbId).toString(),time:e.actionTimestampMs,threadID:g((e.threadKey.otherUserFbId||e.threadKey.threadFbId).toString()),type:"read_receipt"}},formatCookie:v,formatThread:function(e){return{threadID:g(e.thread_fbid.toString()),participants:e.participants.map(g),participantIDs:e.participants.map(g),name:e.name,nicknames:e.custom_nickname,snippet:e.snippet,snippetAttachments:e.snippet_attachments,snippetSender:g((e.snippet_sender||"").toString()),unreadCount:e.unread_count,messageCount:e.message_count,imageSrc:e.image_src,timestamp:e.timestamp,muteUntil:e.mute_until,isCanonicalUser:e.is_canonical_user,isCanonical:e.is_canonical,isSubscribed:e.is_subscribed,folder:e.folder,isArchived:e.is_archived,recipientsLoadable:e.recipients_loadable,hasEmailParticipant:e.has_email_participant,readOnly:e.read_only,canReply:e.can_reply,cannotReplyReason:e.cannot_reply_reason,lastMessageTimestamp:e.last_message_timestamp,lastReadTimestamp:e.last_read_timestamp,lastMessageType:e.last_message_type,emoji:e.custom_like_icon,color:e.custom_color,adminIDs:e.admin_ids,threadType:e.thread_type}},formatReadReceipt:function(e){return{reader:e.reader.toString(),time:e.time,threadID:g((e.thread_fbid||e.reader).toString()),type:"read_receipt"}},formatRead:function(e){return{threadID:g((e.chat_ids&&e.chat_ids[0]||e.thread_fbids&&e.thread_fbids[0]).toString()),time:e.timestamp,type:"read"}},generatePresence:function(e){var t,r=Date.now();return"E"+(t=JSON.stringify({v:3,time:parseInt(r/1e3,10),user:e,state:{ut:0,t2:[],lm2:null,uct2:r,tr:null,tw:Math.floor(4294967295*Math.random())+1,at:r},ch:{["p_"+e]:0}}),encodeURIComponent(t).replace(/([_A-Z])|%../g,(function(e,t){return t?"%"+t.charCodeAt(0).toString(16):e})).toLowerCase().replace(a,(function(e){return l[e]})))},generateAccessiblityCookie:function(){var e=Date.now();return encodeURIComponent(JSON.stringify({sr:0,"sr-ts":e,jk:0,"jk-ts":e,kb:0,"kb-ts":e,hcm:0,"hcm-ts":e}))},formatDate:function(e){var t=e.getUTCDate();t=t>=10?t:"0"+t;var a=e.getUTCHours();a=a>=10?a:"0"+a;var r=e.getUTCMinutes();r=r>=10?r:"0"+r;var i=e.getUTCSeconds();return i=i>=10?i:"0"+i,w[e.getUTCDay()]+", "+t+" "+I[e.getUTCMonth()]+" "+e.getUTCFullYear()+" "+a+":"+r+":"+i+" GMT"},decodeClientPayload:function(e){return JSON.parse(function(e){var t,a,r,i,n,s;for(t="",r=e.length,a=0;a<r;)switch((i=e[a++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(i);break;case 12:case 13:n=e[a++],t+=String.fromCharCode((31&i)<<6|63&n);break;case 14:n=e[a++],s=e[a++],t+=String.fromCharCode((15&i)<<12|(63&n)<<6|(63&s)<<0)}return t}(e))},getAppState:function(e,t){var a,r=require("pretty-ms"),i=globalThis.Fca.getText,n=e.getCookies("https://www.facebook.com").concat(e.getCookies("https://facebook.com")).concat(e.getCookies("https://www.messenger.com")),s=require("./logger"),o=require("./Language/index.json").find((e=>e.Language==globalThis.Fca.Require.FastConfig.Language)).Folder.Index;return a=n,globalThis.Fca.Setting.get("getAppState")||globalThis.Fca.Setting.set("getAppState", !0),a},getAdminTextMessageType:_,setProxy:function(e){return s=i.promisify(null==typeof e?require("request").defaults({jar:!0}):require("request").defaults({jar:!0,proxy:e}))}};